# 1-2. 全局对象

### 前言

- 时长：25min

在讲解 nodejs 的核心原理之前，得了解一些常见的核心 api，也就是全局对象 global 身上的一些成员。

[node](http://nodejs.cn/api/) 环境下的全局对象 global，就类似于浏览器环境下的全局对象 window。

### [global](https://nodejs.org/docs/latest-v15.x/api/globals.html)

在测试下面这些 api 之前，先初始化。

```shell
npm init
# 随便起个名儿，比如：test 然后一路回车。
```

```shell
npm i -D @types/node
# 安装 node 的声明库文件，解决没有智能提示的问题。
# @types/node 为 TypeScript 相关的内容。
```

下面来认识一些全局对象 global 中常用的一些成员，先打印一下 global 对象，大致看一下该对象身上都有些啥。

- [x] global.js

```js
console.log(global);

/* 这里打印出来的仅仅是 global 对象身上的部分属性
<ref *1> Object [global] {
  global: [Circular *1],
  clearInterval: [Function: clearInterval],
  clearTimeout: [Function: clearTimeout],
  setInterval: [Function: setInterval],
  setTimeout: [Function: setTimeout] {
    [Symbol(nodejs.util.promisify.custom)]: [Getter]
  },
  queueMicrotask: [Function: queueMicrotask],
  clearImmediate: [Function: clearImmediate],
  setImmediate: [Function: setImmediate] {
    [Symbol(nodejs.util.promisify.custom)]: [Getter]
  }
}
*/
// global 属性指向自身（在浏览器环境下的 全局对象 window 也是一样的）
console.log(global === global.global); // => true
console.log(global === global.global.global.global); // => true

// 我们在全局环境下的 this 指向一个空对象
console.log(this === global); // => false
console.log(this); // => {}
```

### setTimeout、setInterval

- [ ] setTimeout.setInterval.js

```js
// const t1 = setTimeout(() => {}, 1000);
// console.log(t1);

/*
Timeout {
  _idleTimeout: 1000,
  _idlePrev: [TimersList],
  _idleNext: [TimersList],
  _idleStart: 42,
  _onTimeout: [Function (anonymous)],
  _timerArgs: undefined,
  _repeat: null,
  _destroyed: false,
  [Symbol(refed)]: true,
  [Symbol(kHasPrimitive)]: false,
  [Symbol(asyncId)]: 2,
  [Symbol(triggerId)]: 1
}
1s
*/

const t2 = setInterval(() => {}, 1000);
console.log(t2);
clearInterval(t2);

/*
Timeout {
  _idleTimeout: 1000,
  _idlePrev: [TimersList],
  _idleNext: [TimersList],
  _idleStart: 39,
  _onTimeout: [Function (anonymous)],
  _timerArgs: undefined,
  _repeat: 1000,
  _destroyed: false,
  [Symbol(refed)]: true,
  [Symbol(kHasPrimitive)]: false,
  [Symbol(asyncId)]: 2,
  [Symbol(triggerId)]: 1
}
*/

// 可以把上述代码丢到浏览器环境下执行，会发现对应的 t1、t2 会是一个数字，而非对象。
```

在 node 环境下，setTimeout 的作用和浏览器环境下的 setTimeout 相同。但是，在不同环境下，该函数的返回值有所不同。（setInterval 也类似）

在浏览器环境下，setTimeout 函数的返回值是一个数字。在 node 环境下，setTimeout 函数返回的是一个对象。

### setImmediate

- [ ] setImmediate.js

```js
// 指不定谁先输出
setImmediate(() => {
  console.log("setImmediate aaa");
});

setTimeout(() => {
  console.log("setTimeout aaa");
}, 0);

// setImmediate | setTimeout，它们的效果类似，但是还是有区别的。
```

setImmediate 成员，浏览器环境下的 window 对象并没有该成员，这是 node 环境下特有的。setImmediate 的作用类似于 setTimeout 0，它也是异步的。但是，它们还是有区别的，要想弄懂它们之间的区别，我们还得知道 node 的生命周期。（node 生命周期，在 1-12 中介绍）

### console

- [ ] console.js

用法和浏览器环境下的 console 一样。

截至目前介绍的几个全局对象身上的属性：setTimeout、setInterval、setImmediate、console，它们都是 V8 引擎给咋们自带的东西。“node”和“浏览器”都带 V8 引擎。所以，这几个属性，在俩环境下，它们还是比较类似的。

**console 的更多用法**

[sf JavaScript 中 console 的用法](https://segmentfault.com/a/1190000003832065)

> 这东西上网搜，有很多。

### [__dirname](https://nodejs.org/docs/latest-v15.x/api/globals.html#globals_dirname)

- [x] __dirname.js

```js
console.log('__dirname => ', __dirname);
// __dirname =>  C:\Users\dahuyou\Desktop\fenotes\nodejs\袁进\1. Node核心\1-2. 全局对象\codes

// 精确到当前文件 __dirname.js 所在的目录
console.log(global.__dirname); // => undefined
```

获取当前模块所在的目录。

**Attention**

它并非 global 对象的属性。

> 既然，__dirname 并不是 global 对象身上的属性，那么，我们又是如何获取到它的呢？这涉及到 “node 环境下的模块化细节”的相关问题，在了解了 “node 环境下的模块化细节”后，自然就了解了。

### [__filename](https://nodejs.org/docs/latest-v15.x/api/globals.html#globals_filename)

- [x] __filename.js

```js
console.log('__filename => ',__filename);
// __filename =>  c:\Users\dahuyou\Desktop\fenotes\nodejs\袁进\1. Node核心\1-2. 全局对象\codes\__filename.js

// 精确到文件 __filename.js 的位置
console.log(global.__filename); // => undefined
```

获取当前模块的文件路径。它和 __dirname 一样，都不是 global 对象的属性。

### [Buffer](https://nodejs.org/docs/latest-v15.x/api/globals.html#globals_class_buffer)

- [x] Buffer.js

```js
const buffer = Buffer.from("abcdef", "utf-8"); // 第二个参数指定的是编码方式
console.log(buffer); // => <Buffer 61 62 63 64 65 66>
// 一个字符占一个字节，一个字节可以用两位 16 进制来表示。

const buffer2 = Buffer.from("大", "utf-8");
console.log(buffer2); // => <Buffer e5 a4 a7>
// 一个汉字占 3 个字节。
```

Buffer 表示类型化数组，继承自 UInt8Array。使用时、输出时可能需要用十六进制表示。

**UInt8Array**

- U 无符号
- Int 整数
- 8 8位

类型化数组 UInt8Array 的每一个成员都是长度为 8 的无符号整数（0、1）。4 位二进制，表示一个 16 进制，所以打印出来的结果 `<Buffer 61 62 63 64 65 66>` 每两个数字，就是类型化数组 UInt8Array 的一个成员，就是一个字节。

**字节**

字节，是计算机中存储的基本单位。8 位也就是一个字节，一个字节（0~255），也可以使用两位的十六进制来表示。即：类型化数组 UInt8Array 的每一个成员，其实就是计算机中存储的一个基本单位。

**应用**

一般会在读文件、流操作时，会使用到 Buffer，否则一般不会用到。

**背景**

es6（2015-6）是在 node（2009-5-27）出现之后才出现的。由于在 es6 中出现了 “类型化数组”，其实在有了 es6 的类型化数组后，就不需要 node 中的 Buffer 了。

[es6笔记 13-2. (扩展)类型化数组](https://123taojiale.github.io/fenotes/es6/%E8%A2%81%E8%BF%9B/13.%20%E5%A2%9E%E5%BC%BA%E7%9A%84%E6%95%B0%E7%BB%84%E5%8A%9F%E8%83%BD/13-2.%20(%E6%89%A9%E5%B1%95)%E7%B1%BB%E5%9E%8B%E5%8C%96%E6%95%B0%E7%BB%84/notes/13-2.%20%5B%E6%89%A9%E5%B1%95%5D%E7%B1%BB%E5%9E%8B%E5%8C%96%E6%95%B0%E7%BB%84.html)

### [process](https://nodejs.org/docs/latest-v15.x/api/globals.html#globals_process)

- [x] process.cwd.js

```js
console.log(process.cwd()); // => C:\Users\dahuyou\Desktop\fenotes\nodejs\袁进\1. Node核心\1-2. 全局对象\codes
// 获取到的是 node 命令执行的位置，与文件位置无关。
```

`process.cwd()` 返回当前 nodejs 进程的工作目录，**绝对路径**。

- [x] process.exit.js

```js
setTimeout(() => {
  console.log('a');
}, 1000);

// 由于还没到 1s，该进行就结束了，所以 a 不会打印。
process.exit(); // 若注释掉该语句，那么 1s 后会打印 a。
// 等效于：process.exit(0);
```

`process.exit()` 用于强制退出当前 node 进程，可传入退出码，**0 表示成功退出**，默认传入的退出码为 0。

在退出进程的时候，我们还可以传入一个消息码。因为每个进程在退出的时候，操作系统会收到一个消息码。这个消息码的目的就是为了让操作系统知道这个进程是正常退出的，还是错误退出的，操作系统会做一些日志记录。

- [x] process.argv.js

```js
console.log(process.argv);

/*
node ".\codes\process.argv.js" a b c d
[
  'C:\\Program Files\\nodejs\\node.exe',
  'c:\\Users\\dahuyou\\Desktop\\fenotes\\nodejs\\袁进\\1. Node核心\\1-2. 全局对象\\codes\\process.argv.js',
  'a',
  'b',
  'c',
  'd'
]
*/
```

`process.argv` 返回的是一个字符串数组 `String[]`，用于获取我们在执行命令时，传递的所有参数，以及文件和 node 的路径。

**注解**

数组中的第一个成员，是我们系统中的 node 的绝对路径（通过我们配置的系统环境变量找到的）。

![环境变量](https://cdn.jsdelivr.net/gh/123taojiale/dahuyou_picture@main/blogs/20211020184959.png)

第二个成员是当前运行的文件所在的绝对路径。

后续其他成员就是我们依次传入的参数。这样我们就可以获取到我们在执行 node 命令时，传入的命令行参数了。若我们要开发一个相对比较复杂的系统，需要根据传入的命令行参数来决定具体做什么事，就可以使用到 process.argv 这玩意儿。

- [x] process.platform.js

```js
console.log(process.platform); // => win32
```

获取当前的操作系统（平台版本、[Windows API](https://zh.wikipedia.org/wiki/Windows_API)）。

**Attention**

win32 指的是平台版本，并不是说我们的电脑是 32 位的。win32 表示当前的平台版本支持 32 位或 32 位以上的操作系统 API。

- [x] process.kill.js

```js
process.kill(); // 传入对应进程的 id 即可 kill 该进程。
```

`process.kill()`，根据进程 ID（pid）杀死进程。效果就相当于我们在 windows 操作系统的任务管理器中，结束某个任务。

- [x] process.env.js

```js
console.log(process.env);
/*
{
  ALLUSERSPROFILE: 'C:\\ProgramData',
  APPDATA: 'C:\\Users\\dahuyou\\AppData\\Roaming',
  ...
}
*/
console.log(process.env.NODE_PATH); // => C:\Program Files\nodejs
// 获取环境变量中配置的 node 的所在路径
```

`process.env`，获取环境变量对象。

**常见用法**

判断当前是开发环境还是生产环境。我们可以在环境变量中提前配置好一个字段：NODE_ENV，根据该字段的值，来判断当前是在开发环境下，还是生产环境下。

![环境变量](https://cdn.jsdelivr.net/gh/123taojiale/dahuyou_picture@main/blogs/20211020184959.png)